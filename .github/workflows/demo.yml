name: Java web application demo1
on: 
  pull_request:
    types:
    - opened
    - labeled
    - unlabeled
#    - edited

  workflow_dispatch:
  push:
env:
  AWS_REGION: us-east-2                 
  ECR_REPOSITORY: java-web-application          
#  IMAGE_TAG: latest   
  ECS_CLUSTER: ecs-demo                
  ECS_SERVICE: my‑ecs‑service                 
  ECS_TASK_DEFINITION_FILE: ecs‑task‑definition.json  # Path in repo to your task def file
  CONTAINER_NAME: java‑web‑application        # Name of the container in the task definition
  
permissions:
  id-token: write
  contents: read
  

jobs:
  build:
    runs-on: ubuntu-latest
    # # Only run if label or commit message condition is met
    # if: |
    #   contains(github.event.head_commit.message, '[deploy]') ||
    #   (github.event_name == 'pull_request' && (
    #     contains(toJson(github.event.pull_request.labels), 'deploy')
    #   )) 
    env:
      AWS_REGION: us-east-2
      ECR_REPOSITORY: java-web-application
    steps:
      - name: Get code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: build maven 
        run: mvn -B clean install -f pom.xml
      # SonarQube Scanner configuration
      # - name: Sonarqube scan
      #   env: 
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: mvn sonar:sonar

    # # Login to DockerHub using secrets for credentials
    #   - name: Login to DockerHub
    #     env:
    #       DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
    #       DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    #     run: echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
    # # Build Docker image with a specific tag
    #   - name: Build Docker Image
    #     run: docker build -t ${{ secrets.DOCKER_USERNAME }}/java-web-application .
    # # Push the built image to DockerHub
    #   - name: Push to DockerHub
    #     run: docker push ${{ secrets.DOCKER_USERNAME }}/java-web-application:latest
        
      # - name: Upload Artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: java-web-app-1.0
      #     path: target/*.war

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::482387069884:role/GithubECSDeployIAMRole
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Tag Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG 
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    #Deploy to ECS 
      - name: Render ECS task definition with new image
        id: render-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEFINITION_FILE }}
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build-image.outputs.image }}

    # Deploy job
  # Deploy:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   # Steps to be executed in the Deploy job
  #   steps:
  #     # # Configure Aws Credentials
  #     # - name: Configure Aws credentials
  #     #   uses: aws-actions/configure-aws-credentials@v5.1.0
  #     #   with:
  #     #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #     #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #     #     aws-region: ${{ secrets.AWS_REGION }}
  #     - name: Deploy to EC2 via SSH
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: ${{ secrets.EC2_HOST }}
  #         username: ${{ secrets.EC2_USER }}
  #         key: ${{ secrets.EC2_SSH_KEY }}
        
  #     # Pull the latest Docker image from DockerHub
  #     - name: Login to DockerHub
  #       env:
  #         DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  #         DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  #       run: echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
  #     - name: Pull the Docker Image
  #       run: docker pull ${{ secrets.DOCKER_USERNAME }}/java-web-application:latest 
  #     - name: Delete old container
  #       run:  docker rm -f java-web-application
  #            # docker stop java-web-application
  #     # Run a new container from the pulled image
  #     - name: Run the Container
  #       run: docker run -d -p 8080:8080 --name java-web-application ${{ secrets.DOCKER_USERNAME }}/java-web-application:latest
      
